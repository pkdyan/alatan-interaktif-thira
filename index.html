<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alatan THIRA Interaktif - PKD Yan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Brilliant Blues -->
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        /* Tab Styles */
        .tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            color: #0077B6; /* Primary Text */
            border-bottom-color: #0077B6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Stepper Styles Baharu */
        .step-nav-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #6b7280; /* gray-500 */
        }
        .step-nav-btn.active {
            color: #0077B6; /* Primary Text */
            border-bottom-color: #0077B6;
            font-weight: 600;
        }
        .step-page {
            display: none;
        }
        .step-page.active {
            display: block;
        }
        
        /* Gaya Cetakan Baharu */
        @media print {
            /* Sembunyikan elemen yang tidak mahu dicetak */
            .no-print {
                display: none !important;
            }
            /* Tunjukkan semua kandungan tab semasa mencetak */
            .tab-content {
                display: block !important;
            }
            /* Baharu: Pastikan semua langkah dipaparkan semasa cetak */
            .step-page {
                display: block !important;
                margin-top: 40px; /* Tambah ruang antara langkah semasa cetak */
            }
            /* Tetapan badan untuk cetakan */
            body {
                background-color: white !important;
                color: black !important;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
            }
            /* Pastikan kad kandungan tidak terpotong */
            .bg-white {
                box-shadow: none !important;
                border: 1px solid #ccc;
                margin-bottom: 20px;
            }
            /* Watermark */
            body::after {
                content: "Pejabat Kesihatan Daerah Yan";
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 60pt; /* Saiz watermark */
                color: rgba(0, 0, 0, 0.08); /* Pudar */
                font-weight: bold;
                pointer-events: none;
                z-index: 9999;
                opacity: 1;
                width: 100vw;
                text-align: center;
            }
        }

        /* Gaya Modal Khusus */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% dari atas dan berpusat */
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="font-sans" style="color: #03045E; background-color: #CAF0F8;">

    <!-- Palette Colors: 
        Bg: #CAF0F8 (Light Blue)
        Bg-Card: #FFFFFF (White)
        Primary Text: #0077B6 (Dark Blue)
        Accent: #00B4D8 (Bright Blue)
        Shadow: #ADE8F4 (Lighter Blue)
    -->

    <!-- Header -->
    <header class="bg-white shadow-md no-print" style="background-color: #FFFFFF; box-shadow: 0 4px 12px 0 #ADE8F4;">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-center flex-1">
                <h1 class="text-2xl md:text-3xl font-bold text-center" style="color: #0077B6;">Alatan Interaktif THIRA PKD Yan</h1>
                <p class="text-center text-lg" style="color: #00B4D8;">Alat Pemarkahan & Senarai Semak</p>
            </div>
            <button id="print-btn" class="font-semibold text-white px-4 py-2 rounded-lg ml-4" style="background-color: #0077B6; hover:background-color: #00B4D8;">
                <span class="mr-2">üñ®Ô∏è</span>Cetak
            </button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-white shadow-sm no-print" style="background-color: #FFFFFF;">
        <div class="container mx-auto flex justify-center">
            <button id="tab-btn-1" class="tab-btn active" data-tab="1">Matriks Risiko (Langkah 1)</button>
            <button id="tab-btn-2" class="tab-btn" data-tab="2">Analisis Jurang (Langkah 4)</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8">

        <!-- Tab 1: Matriks Pemarkahan Risiko -->
        <div id="tab-content-1" class="tab-content active">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8" style="box-shadow: 0 10px 25px -5px #ADE8F4;">
                <h2 class="text-3xl font-bold mb-4" style="color: #0077B6;">Alat 1: Matriks Pemarkahan Risiko</h2>

                <!-- Stepper Nav (Tab 1) -->
                <nav class="flex justify-center border-b no-print mb-6">
                    <button class="step-nav-btn active" data-tab="1" data-step="1">Muka 1: Masukkan Data</button>
                    <button class="step-nav-btn" data-tab="1" data-step="2">Muka 2: Lihat Matriks</button>
                    <button class="step-nav-btn" data-tab="1" data-step="3">Muka 3: Lihat Jadual</button>
                </nav>

                <!-- Step 1-1: Form -->
                <div id="step-page-1-1" class="step-page active">
                    <h3 class="text-2xl font-semibold mb-4 text-center" style="color: #0077B6;">Muka 1: Masukkan Data Ancaman</h3>
                    <p class="text-lg mb-6 text-center">Gunakan borang ini untuk menambah ancaman dan memberi skor.</p>
                    <form id="threat-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 rounded-lg shadow-inner no-print" style="background-color: #CAF0F8;">
                        <h3 class="text-xl font-semibold md:col-span-2" style="color: #0077B6;">Tambah Ancaman Baharu</h3>
                        <div>
                            <label for="threat-name" class="block font-semibold mb-1">Nama Ancaman</label>
                            <input type="text" id="threat-name" class="w-full p-2 border rounded" placeholder="Cth: Banjir Kilat Sg. Yan" required>
                        </div>
                        <div>
                            <label for="threat-likelihood" class="block font-semibold mb-1">Kebarangkalian (1-5)</label>
                            <input type="number" id="threat-likelihood" class="w-full p-2 border rounded" min="1" max="5" step="0.1" placeholder="Cth: 4.2" required>
                        </div>
                        <div>
                            <label for="threat-impact-health" class="block font-semibold mb-1">Kesan Kesihatan (1-5)</label>
                            <input type="number" id="threat-impact-health" class="w-full p-2 border rounded" min="1" max="5" step="0.1" placeholder="Cth: 3.5" required>
                        </div>
                        <div>
                            <label for="threat-impact-infra" class="block font-semibold mb-1">Kesan Infrastruktur/Ekonomi (1-5)</label>
                            <input type="number" id="threat-impact-infra" class="w-full p-2 border rounded" min="1" max="5" step="0.1" placeholder="Cth: 4.0" required>
                        </div>
                        <div class="md:col-span-2 text-right space-x-2">
                            <button type="button" id="reset-threats-btn" class="font-semibold text-gray-700 bg-gray-200 px-6 py-2 rounded-lg hover:bg-gray-300">Padam Data</button>
                            <button type="submit" class="font-semibold text-white px-6 py-2 rounded-lg" style="background-color: #0077B6; hover:background-color: #00B4D8;">Tambah ke Matriks</button>
                        </div>
                    </form>
                    
                    <!-- Ruang ini dahulu tempat Import/Export, kini dibuang -->
                </div>

                <!-- Step 1-2: Chart -->
                <div id="step-page-1-2" class="step-page">
                    <h3 class="text-2xl font-semibold mb-4 text-center" style="color: #0077B6;">Muka 2: Matriks Risiko (Real-time)</h3>
                    <div class="chart-container">
                        <canvas id="riskMatrixChart"></canvas>
                    </div>
                </div>

                <!-- Step 1-3: Table -->
                <div id="step-page-1-3" class="step-page">
                    <h3 class="text-2xl font-semibold mb-4 text-center" style="color: #0077B6;">Muka 3: Senarai Ancaman Diutamakan</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200" style="color: #0077B6;">
                                <tr>
                                    <th class="py-2 px-4 text-left">Ancaman</th>
                                    <th class="py-2 px-4 text-center">Kebarangkalian</th>
                                    <th class="py-2 px-4 text-center">Purata Kesan</th>
                                    <th class="py-2 px-4 text-center">SKOR AKHIR</th>
                                </tr>
                            </thead>
                            <tbody id="threat-table-body">
                                <!-- Data akan diisi oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Analisis Jurang Sumber -->
        <div id="tab-content-2" class="tab-content">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8" style="box-shadow: 0 10px 25px -5px #ADE8F4;">
                <h2 class="text-3xl font-bold mb-4" style="color: #0077B6;">Alat 2: Senarai Semak & Analisis Jurang Sumber</h2>

                <!-- Stepper Nav (Tab 2) -->
                <nav class="flex justify-center border-b no-print mb-6">
                    <button class="step-nav-btn active" data-tab="2" data-step="1">Muka 1: Masukkan Data</button>
                    <button class="step-nav-btn" data-tab="2" data-step="2">Muka 2: Lihat Jadual</button>
                    <button class="step-nav-btn" data-tab="2" data-step="3">Muka 3: Lihat Carta</button>
                </nav>

                <!-- Step 2-1: Form -->
                <div id="step-page-2-1" class="step-page active">
                    <h3 class="text-2xl font-semibold mb-4 text-center" style="color: #0077B6;">Muka 1: Masukkan Data Sumber</h3>
                    <p class="text-lg mb-6 text-center">Gunakan borang ini untuk Langkah 4. Masukkan sumber yang "Diperlukan" dan "Sedia Ada".</p>
                    <form id="resource-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 rounded-lg shadow-inner no-print" style="background-color: #CAF0F8;">
                        <h3 class="text-xl font-semibold md:col-span-3" style="color: #0077B6;">Tambah Sumber ke Senarai Semak</h3>
                        <div>
                            <label for="resource-name" class="block font-semibold mb-1">Nama Sumber</label>
                            <input type="text" id="resource-name" class="w-full p-2 border rounded" placeholder="Cth: Set PPE" required>
                        </div>
                        <div>
                            <label for="resource-needed" class="block font-semibold mb-1">Jumlah Diperlukan</label>
                            <input type="number" id="resource-needed" class="w-full p-2 border rounded" placeholder="Cth: 500" required>
                        </div>
                        <div>
                            <label for="resource-available" class="block font-semibold mb-1">Jumlah Sedia Ada</label>
                            <input type="number" id="resource-available" class="w-full p-2 border rounded" placeholder="Cth: 100" required>
                        </div>
                        <div class="md:col-span-3 text-right space-x-2">
                            <button type="button" id="reset-resources-btn" class="font-semibold text-gray-700 bg-gray-200 px-6 py-2 rounded-lg hover:bg-gray-300">Padam Data</button>
                            <button type="submit" class="font-semibold text-white px-6 py-2 rounded-lg" style="background-color: #0077B6; hover:background-color: #00B4D8;">Tambah ke Senarai</button>
                        </div>
                    </form>
                </div>

                <!-- Step 2-2: Table -->
                <div id="step-page-2-2" class="step-page">
                    <h3 class="text-2xl font-semibold mb-4 text-center" style="color: #0077B6;">Muka 2: Senarai Semak Sumber (Real-time)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200" style="color: #0077B6;">
                                <tr>
                                    <th class="py-2 px-4 text-left">Sumber</th>
                                    <th class="py-2 px-4 text-center">Diperlukan</th>
                                    <th class="py-2 px-4 text-center">Sedia Ada</th>
                                    <th class="py-2 px-4 text-center">JURANG</th>
                                    <th class="py-2 px-4 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="resource-table-body">
                                <!-- Data akan diisi oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Step 2-3: Chart -->
                <div id="step-page-2-3" class="step-page">
                    <h3 class="text-2xl font-semibold mb-4 text-center" style="color: #0077B6;">Muka 3: Visualisasi Jurang Sumber</h3>
                    <div class="chart-container">
                        <canvas id="gapAnalysisChart"></canvas>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Modal for Custom Alert/Confirm -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <h4 id="modalTitle" class="text-xl font-bold mb-3" style="color: #0077B6;">Makluman</h4>
            <p id="modalMessage" class="mb-4 text-gray-700"></p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400" style="display:none;">Batal</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">OK</button>
            </div>
        </div>
    </div>


    <!-- Footer -->
    <footer class="text-center p-6 mt-8 no-print">
        <p class="text-sm" style="color: #0077B6;">Hakcipta Pejabat Kesihatan Daerah Yan &copy; 2025</p>
    </footer>

    <script type="module">
        
        let threats = []; // Data Ancaman (Matriks Risiko)
        let resources = []; // Data Sumber (Analisis Jurang)
        let riskMatrixChart;
        let gapAnalysisChart;

        // --- FUNGSI MODAL KASTOM (Ganti alert/confirm) ---
        // Global references
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');

        function showModal(title, message, isConfirm = false) {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                customModal.style.display = 'block';

                // Reset event listeners
                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;

                if (isConfirm) {
                    modalCancelBtn.style.display = 'inline-block';
                    modalConfirmBtn.textContent = 'Sahkan';
                    modalConfirmBtn.style.backgroundColor = '#EF4444'; // Red-500 for delete
                    modalConfirmBtn.style.hover = 'background-color: #DC2626';

                    modalConfirmBtn.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(true);
                    };
                    modalCancelBtn.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(false);
                    };
                } else {
                    modalCancelBtn.style.display = 'none';
                    modalConfirmBtn.textContent = 'OK';
                    modalConfirmBtn.style.backgroundColor = '#10B981'; // Green-500 for OK
                    modalConfirmBtn.style.hover = 'background-color: #059669';
                    
                    modalConfirmBtn.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(true);
                    };
                }
            });
        }


        // --- FUNGSI CHART INIALIZATION (Mesti diinisialisasi sekali) ---
        function initializeRiskMatrixChart() {
            const ctx = document.getElementById('riskMatrixChart').getContext('2d');
            riskMatrixChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ancaman',
                        data: [],
                        backgroundColor: 'rgba(0, 180, 216, 0.6)',
                        borderColor: 'rgba(0, 119, 182, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Kebarangkalian ‚ûî', font: { size: 14, weight: 'bold' }, color: '#0077B6' },
                            min: 0,
                            max: 5,
                            grid: { color: '#ADE8F4' }
                        },
                        y: {
                            title: { display: true, text: 'Purata Kesan ‚ûî', font: { size: 14, weight: 'bold' }, color: '#0077B6' },
                            min: 0,
                            max: 5,
                            grid: { color: '#ADE8F4' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    let label = item.chart.data.labels[item.dataIndex];
                                    if (Array.isArray(label)) {
                                      return label.join(' ');
                                    } else {
                                      return label;
                                    }
                                },
                                label: function(context) {
                                    const raw = context.raw;
                                    return ` (Kebarangkalian: ${raw.x}, Kesan: ${raw.y})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initializeGapChart() {
            const ctx = document.getElementById('gapAnalysisChart').getContext('2d');
            gapAnalysisChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Sedia Ada',
                            data: [],
                            backgroundColor: 'rgba(0, 119, 182, 0.8)', // Dark Blue
                        },
                        {
                            label: 'Diperlukan',
                            data: [],
                            backgroundColor: 'rgba(173, 232, 244, 0.8)', // Light Blue
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#ADE8F4' } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    let label = item.chart.data.labels[item.dataIndex];
                                    if (Array.isArray(label)) {
                                        return label.join(' ');
                                    } else {
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- FUNGSI UNTUK MENGEMAS KINI UI TAB 1 SAHAJA ---
        function updateThreatTableUI() {
            const threatTableBody = document.getElementById('threat-table-body');
            
            threatTableBody.innerHTML = '';
            
            // Pastikan carta telah diinisialisasi
            if (!riskMatrixChart) return;

            // Isih ancaman berdasarkan SKOR AKHIR, tertinggi dahulu
            threats.sort((a, b) => b.totalScore - a.totalScore);
            
            riskMatrixChart.data.labels = [];
            const chartData = [];

            threats.forEach(threat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${threat.name}</td>
                    <td class="py-2 px-4 border-b text-center">${parseFloat(threat.likelihood).toFixed(1)}</td>
                    <td class="py-2 px-4 border-b text-center">${parseFloat(threat.avgImpact).toFixed(1)}</td>
                    <td class="py-2 px-4 border-b text-center font-bold" style="color: #0077B6;">${parseFloat(threat.totalScore).toFixed(1)}</td>
                `;
                threatTableBody.appendChild(row);
                
                // Sediakan data untuk carta
                let label = threat.name;
                if (label.length > 16) {
                    label = [label.substring(0, 16) + '...']; 
                }
                riskMatrixChart.data.labels.push(label);
                chartData.push({
                    x: parseFloat(threat.likelihood),
                    y: parseFloat(threat.avgImpact),
                    r: parseFloat(threat.totalScore) * 2 // Saiz gelembung berdasarkan skor
                });
            });
            
            riskMatrixChart.data.datasets[0].data = chartData;
            riskMatrixChart.update();
        }

        // FUNGSI UNTUK MENGEMAS KINI UI TAB 2 SAHAJA
        function updateResourceTableUI() {
            const resourceTableBody = document.getElementById('resource-table-body');
            
            resourceTableBody.innerHTML = '';
            
            // Pastikan carta telah diinisialisasi
            if (!gapAnalysisChart) return;

            const chartLabels = [];
            const chartDataNeeded = [];
            const chartDataAvailable = [];

            resources.forEach(res => {
                const needed = parseInt(res.needed) || 0;
                const available = parseInt(res.available) || 0;
                const gap = needed - available;
                let statusClass = '';
                let statusText = '';

                if (gap > 0) {
                    statusClass = 'text-red-600 font-bold';
                    statusText = `Kurang ${gap}`;
                } else {
                    statusClass = 'text-green-600 font-bold';
                    statusText = `Mencukupi (${Math.abs(gap)} lebihan)`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${res.name}</td>
                    <td class="py-2 px-4 border-b text-center">${needed}</td>
                    <td class="py-2 px-4 border-b text-center">${available}</td>
                    <td class="py-2 px-4 border-b text-center ${statusClass}">${gap}</td>
                    <td class="py-2 px-4 border-b text-center ${statusClass}">${statusText}</td>
                `;
                resourceTableBody.appendChild(row);

                chartLabels.push(processLabel(res.name));
                chartDataNeeded.push(needed);
                chartDataAvailable.push(available);
            });

            gapAnalysisChart.data.labels = chartLabels;
            gapAnalysisChart.data.datasets[0].data = chartDataAvailable;
            gapAnalysisChart.data.datasets[1].data = chartDataNeeded;
            gapAnalysisChart.update();
        }

        function processLabel(label) {
            if (label.length > 16) {
                const words = label.split(' ');
                let lines = [];
                let currentLine = '';
                for (const word of words) {
                    if ((currentLine + word).length > 16) {
                        lines.push(currentLine.trim());
                        currentLine = word + ' ';
                    } else {
                        currentLine += word + ' ';
                    }
                }
                lines.push(currentLine.trim());
                return lines;
            }
            return label;
        }

        // --- FUNGSI SIMPAN/MUAT LOKAL (localStorage) ---

        function saveData() {
            // Simpan kedua-dua set data dalam localStorage
            localStorage.setItem('thira_threats', JSON.stringify(threats));
            localStorage.setItem('thira_resources', JSON.stringify(resources));
            console.log("Data disimpan secara automatik ke local storage.");
        }

        function loadData() {
            // Muat semula data ancaman
            const storedThreats = localStorage.getItem('thira_threats');
            if (storedThreats) {
                try {
                    // Hanya parse data, biarkan UI update di luar
                    threats = JSON.parse(storedThreats);
                } catch (e) {
                    console.error("Ralat memuatkan data ancaman dari storage:", e);
                    threats = [];
                }
            }
            // Panggil fungsi kemas kini UI selepas fungsi ditakrifkan
            updateThreatTableUI(); 

            // Muat semula data sumber
            const storedResources = localStorage.getItem('thira_resources');
            if (storedResources) {
                try {
                    // Hanya parse data, biarkan UI update di luar
                    resources = JSON.parse(storedResources);
                } catch (e) {
                    console.error("Ralat memuatkan data sumber dari storage:", e);
                    resources = [];
                }
            }
            // Panggil fungsi kemas kini UI selepas fungsi ditakrifkan
            updateResourceTableUI(); 
        }

        // --- FUNGSI IMPORT/EXPORT (Kini Dibuang) ---

        // Fungsi-fungsi ini dikekalkan sebagai placeholder kosong sekiranya diperlukan, tetapi tidak dipanggil
        function exportDataAsJson() {
            showModal('Makluman', 'Fungsi Export telah dibuang atas permintaan pengguna.');
        }

        async function importDataFromJson(file) {
            await showModal('Makluman', 'Fungsi Import telah dibuang atas permintaan pengguna.');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. INISIALISASI CARTA & MUAT DATA LOKAL ---
            initializeRiskMatrixChart();
            initializeGapChart();
            loadData(); // Panggil loadData dari localStorage

            
            // --- 2. Logik Tab & Stepper ---
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabContents.forEach(content => {
                        if (content.id === `tab-content-${tabId}`) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });
            
            const stepButtons = document.querySelectorAll('.step-nav-btn');
            
            stepButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    const stepId = button.getAttribute('data-step');

                    if (document.getElementById(`tab-content-${tabId}`).classList.contains('active')) {
                        document.querySelectorAll(`.step-nav-btn[data-tab="${tabId}"]`).forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');

                        document.querySelectorAll(`.step-page[id^="step-page-${tabId}-"]`).forEach(page => {
                            page.classList.remove('active');
                        });
                        document.getElementById(`step-page-${tabId}-${stepId}`).classList.add('active');
                    }
                });
            });


            // --- Logik Butang Cetak Baharu ---
            const printButton = document.getElementById('print-btn');
            printButton.addEventListener('click', () => {
                window.print();
            });

            // --- 3. Logik Alat 1: Matriks Risiko ---
            const threatForm = document.getElementById('threat-form');
            const resetThreatsBtn = document.getElementById('reset-threats-btn');


            // FUNGSI UNTUK MENGEMAS KINI DATA LOKAL DAN TRIGGE SIMPANAN
            function handleThreatsUpdate() {
                updateThreatTableUI();
                saveData(); // Panggil fungsi simpan ke localStorage
            }

            threatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('threat-name').value;
                const likelihood = parseFloat(document.getElementById('threat-likelihood').value);
                const impactHealth = parseFloat(document.getElementById('threat-impact-health').value);
                const impactInfra = parseFloat(document.getElementById('threat-impact-infra').value);
                
                const avgImpact = (impactHealth + impactInfra) / 2;
                const totalScore = likelihood * avgImpact; // Skor Risiko = Kebarangkalian x Purata Kesan

                threats.push({ 
                    name, 
                    likelihood, 
                    impactHealth, 
                    impactInfra, 
                    avgImpact, 
                    totalScore 
                });
                handleThreatsUpdate();
                threatForm.reset();
            });

            // Listener untuk butang reset ancaman
            resetThreatsBtn.addEventListener('click', async () => {
                const isConfirmed = await showModal('Padam Data Ancaman', 'Adakah anda pasti mahu memadamkan SEMUA data ancaman? Tindakan ini tidak boleh diundur.', true);
                if(isConfirmed){
                    threats = [];
                    handleThreatsUpdate(); // Ini akan mengosongkan jadual, carta, dan data local storage
                }
            });

            // --- 4. Logik Alat 2: Analisis Jurang ---
            const resourceForm = document.getElementById('resource-form');
            const resetResourcesBtn = document.getElementById('reset-resources-btn');

            // FUNGSI UNTUK MENGEMAS KINI DATA LOKAL DAN TRIGGER SIMPANAN
            function handleResourcesUpdate() {
                updateResourceTableUI();
                saveData(); // Panggil fungsi simpan ke localStorage
            }

            resourceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('resource-name').value;
                const needed = parseInt(document.getElementById('resource-needed').value);
                const available = parseInt(document.getElementById('resource-available').value);

                resources.push({ name, needed, available });
                handleResourcesUpdate();
                resourceForm.reset();
            });

            // Listener untuk butang reset sumber
            resetResourcesBtn.addEventListener('click', async () => {
                const isConfirmed = await showModal('Padam Data Sumber', 'Adakah anda pasti mahu memadamkan SEMUA data sumber? Tindakan ini tidak boleh diundur.', true);
                if(isConfirmed){
                    resources = [];
                    handleResourcesUpdate(); // Ini akan mengosongkan jadual, carta, dan data local storage
                }
            });
            
            // --- 5. Event Listeners Import/Export (Dibuang) ---
            // Kod Import/Export telah dibuang dari sini
            
        });
    </script>
</body>
</html>